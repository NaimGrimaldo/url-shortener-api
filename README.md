# Url-shortener-api

Rails api application for Test. Uses external JWT for login.

Project specs

    Ruby version 2.6.6

    Rails version 6.0.3

    Database manager postgresql

    Testing framewrok rspec
    
## Install project
[How to prepare my work environment?](https://gorails.com/setup/ubuntu/16.04)


#### Clone the repository
```
git clone git@github.com:NaimGrimaldo/url-shortener-api.git
cd url-shortener-api
```

#### Check your Ruby version
```
ruby -v
```
The ouput should start with something like `ruby 2.6.6`
If not, install the right ruby version using [rbenv](https://github.com/rbenv/rbenv) (it could take a while):

```
rbenv install 2.6.6
rbenv global 2.6.6
rbenv rehash 
```

#### Install dependences (Gems)
Using [Bundler](https://github.com/bundler/bundler)

```
bundle install
```

#### Prepare database
```
rails db:create 
rails db:migrate 
rails db:seed
```

#### Run rails server

```
rails server
```

#### Run tests suite
```
bundle exec rspec
```

This project is prepared to use a config/local_env.yml file to load all env variables used for the database credentials
```
URL_SHORTENER_BACK_DATABASE_PASSWORD: 'your pass'
URL_SHORTENER_BACK_DATABASE_USERNAME:  'your user'
URL_SHORTENER_BACK_DATABASE_HOST: 'your host'
URL_SHORTENER_BACK_DATABASE_PORT: 'your port'
```
#### Services as Commands  with simple_command
  * AuthenticateUser: encharged to perform the user authentication
     * lib/JsonWebToken: module to manage the tokens (decode, encode)
  * AuthorizeApiRequest: this command is consumed on all api request to validate the authenticity, excepts for the visit url request and user creation.
  
### Routes
```
scope :api do
  resources :users do
    resources :links
  end
  post 'authenticate', to: 'authentication#authenticate'
end
get '/:id', to: 'links#visit', as: :short
```
#### How its works
* All models, acts_as_paranoid:
  * User
    * has_many links
    * validates presence of:
        * name
        * last_name
        * email
        * password
    * has secure_password
    * validates:
       * password:
         * length: more than 6 characters 
         * case sensitive: true
       * email:
         * uniqueness: true
         * format: URI::MailTo::EMAIL_REGEXP
          
  * Link
    * include Rails.application.routes.url_helpers
    * charset used to generate the unique_key:
      * CHARSET = ('a'..'z').to_a + ('A'..'Z').to_a + (0..9).to_a
    * REGEX used to valid the url:
      * RGX_URL_PROTOCOL = Regexp.new('\Ahttp:\/\/|\Ahttps:\/\/', Regexp::IGNORECASE)
    * belongs_to :user
    * has_many :visitors
    * validates:
        * presence_of:
          * original_url
          * unique_key
        * uniquenes_of:
          * unique_key
          * original_url      
  * Visitor
    * belongs_to :link
    * has_many :visitor_agents
    * enum :visitor_kind
  * VisitorAgent
    * belongs_to :visitor
* Link creation (link.rb):
  * Depends on the received params, set the unique_key and expire_at if are present
  * validates presence :original_url, :unique_key
  * validate format of :original_url
      * clean_url, by REGEX
        * return the url if match with regex
        * else normalize the original_url
      * compare it after cleaning if cointains a protocol and if its valid
        * rescue 'invalid url' for errors
   * the unique_key generates itself if doesnt present:
      * max_length: 10
      * if the api generate the key
        * this key has 6 characters and are obtained for a alphanumeric charset, iterated 6 times obtaining a random character from the charset  by random number between the charset size
   * after link is valid and created the controller return the instance method @link.short_url(url_options: {})
      * this method obtains as parameters the request data to perfom a call  to the LinksController#visit method to generate the shortened_url
        *route: get '/:id', to: 'links#visit', as: :short
          * the request params used are: :host, :port, :domain,  only if its necessary
          * the route id is referring to the gived or autogenerated link unique_key
         ```
            def short_url(url_options: {})
              options = {
                controller: :"/links",
                action: :visit, id: unique_key,
                only_path: false
              }.merge(url_options)

              url_for(options)
            end
         ```
* Visit link: When a link is visited
  * validates if exists a link with the gived unique_key
  * render :not_found unless link exists
  * validates if the link was expired
  * create agent with the request.user_agent
  * perfom @link.visit!(agent, request)
      * this method increse the visit counte for the object
      * find or create a Visitor with the request IP
        * increase the visitor visits counter to manage how many times entered to the url
        * find or create a VisitorAgent with user agent name and user agent OS
        * increse VisitorAgent visits counter
        * update :visited_at for the VisitorAgent to save when it was the visit
        * if the Visitor is not a new record
          * validates if has more than one agent and more than one visit
            * if its true update Visitor column :visitor_kind to :recurrent
      
  * redirect_to @link.original_url 

#### How to use it
* Create an user: the api validates the uniqueness and format of the email, the minimun charactes for the password is 6 and its case sensitive
 ```
  POST: ':host'/api/users
  Content-Type : Content-Type: application/json
  PARAMS { 
    'user': { 
      'name': 'your name',
      'last_name': 'your_last_name',
      'email' : 'your@email.com',
      'password': 'some_password'
    } 
  }
  
  
  RESPONSE: 
    {
      "id": ID,
      "name": NAME,
      "last_name": LAST_NAME,
      "email": EMAIL,
      "password_digest": "PASSWORD DIGEST",
      "deleted_at": null,
      "created_at": "DATES",
      "updated_at": "DATES"
    }
```
* Authenticate: this endpoint generates the authorization token used to authenticate all the new posibles requests
 ```
  POST: ':host'/api/authenticate
  Content-Type : Content-Type: application/json
  PARAMS { 'email' : 'your@email.com', 'password': 'some_password' } 
  
  RESPONSE:
    {
      "auth_token":"eyJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxLCJleHAiOjE2MDY5MDE1Njd9.PHR2OYM71nzwuRQhcLhWlqCo-gUbQv5-KdMJBN2cc4E"
      }
      
  * create link:  this request create a shorten url, able to beeing visited, validate uniquess of unique_key and original_url:
  POST: ':host'/api/users/:user_id/links
  Content-Type : Content-Type: application/json
  Autorizaton: JWT TOKEN
  PARAMS { 
    'link': { 
      'original_url': 'your name',
      'unique_key': 'optional',
      'expires_at' : 'optional'
    } 
  }
  
  
  RESPONSE: 
    {
      "id": ID,
      "original_url": "ORIGINAL_URL",
      "expires_at": null,
      "visits": 0,
      "unique_key": "UNIQUE_KEY",
      "short_url": "http://192.168.0.5:3000/tNtRG" ##EXAMPLE
    }
    
  * Get user links:
   POST: ':host'/api/users/:id/links
   Content-Type : Content-Type: application/json
   Autorizaton: JWT TOKEN
   RESPONSE: {
    "links": [
        {
            "id": ID,
            "original_url": "ORIGINAL_URL,
            "user_id": USER_ID,
            "unique_key": "UNIQUE_KEY",
            "visits": 0,
            "expires_at": "OPTIONAL DATE",
            "deleted_at": null,
            "created_at": "DATE",
            "updated_at": "DATE"
        },
      .......
     ]
   }
   
  * Get user link:
  GET: ':host'/api/users/:user_id/links/:link_id
  Content-Type : Content-Type: application/json
  Autorizaton: JWT TOKEN
  RESPONSE: {
   "id": ID,
   "original_url": "ORIGINAL_URL",
   "expires_at": "OPTIONAL DATE,
   "visits": NUMBER_VISITS,
   "unique_key": "UNIQUE_KEY",
   "short_url": "SHORT_URL",
   "visitors": [
       {
           "id": VISITOR_ID,
           "ip": "VISITOR_IP",
           "visits": TOTAL_NUMBER_VISITS,
           "visitor_kind": TYPE %[unique recurrent],
           "visits_percentage": VISITS_PERCENTAGE,
           "visitor_agents": [
               {
                   "id": AGENT_ID,
                   "agent": "AGENT_NAME",
                   "os": "AGENT_OS",
                   "visitor_id": VISITOR_ID,
                   "visits": AGENT_VISITS,
                   "visited_at": "LAST_VISIT_DATE",
                   "deleted_at": null,
                   "created_at": "DATES",
                   "updated_at": "DATES"
               },
               .......
           ]
       }
    ]
  }
   
 * DESTROY USER LINK:
  DELETE: ':host'/api/users/:user_id/links/:link_id
  Content-Type : Content-Type: application/json
  Autorizaton: JWT TOKEN
  RESPONSE: 
   * head: :ok if success
   * head: :unprocessable_entity if fails
   
```
### GEMS
```
gem 'active_model_serializers', '~> 0.10.0'
gem 'bcrypt', '~> 3.1.7'
gem 'jwt'
gem 'paranoia'
gem 'rack-cors'
gem 'simple_command'
gem 'user-agent', '~> 1.0'
```
